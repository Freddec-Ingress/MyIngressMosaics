{% extends 'base.html' %}

{% load i18n %}

{% block extra-head %}

	<title>MIM - {{name}}</title>
	
	<meta name="abstract" content="{{desc}}" />
	<meta name="description" content="{{desc}}" />

	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://www.myingressmosaics.com/mosaic/{{ref}}" />
	<meta property="og:site_name" content="MIM - MyIngressMosaics" />
	<meta property="og:image" content="https://storage.googleapis.com/myingressmosaics-previews/{{ref}}.png" />
	<meta property="og:image:secure_url" content="https://storage.googleapis.com/myingressmosaics-previews/{{ref}}.png" />
	<meta property="og:headline" content="MIM - {{name}}" />
	<meta property="og:description" content="{{desc}}" />
	<meta property="og:image:width" content="632" />
	<meta property="og:image:height" content="{{img_height}}" />

{% endblock %}

{% block header %}

	{% trans 'Mosaic' %}
	
{% endblock %}

{% block content %}

<div id="page-container" ng-controller="MosaicCtrl" ng-init="loadMosaic('{{ref}}');">

{% verbatim %}

	<div ng-show="!mosaic" class="block ta-center c-danger">
		No mosaic found
	</div>

	<div ng-show="mosaic">
		
		<div class="block">
			<div class="title">
				<div class="row">
					<div class="item grow">
						<a href="/"><i class="fa fa-home text-separator" style="margin-left:0;"></i> Home</a>
						<span class="text-separator">></span>
						<a href="/world/{{mosaic.country.name}}">{{mosaic.country.name}}</a>
						<span class="text-separator">></span>
						<a href="/world/{{mosaic.country.name}}/{{mosaic.region.name}}">{{mosaic.region.name}}</a>
						<span class="text-separator">></span>
						<a href="/world/{{mosaic.country.name}}/{{mosaic.region.name}}/{{mosaic.city.name}}">{{mosaic.city.name}}</a>
					</div>
					<div class="item">
						<a href="/map/{{mosaic.city.name}},{{mosaic.region.name}},{{mosaic.country.name}}">
							<i class="fa fa-map text-separator"></i>
							Map
						</a>
					</div>
				</div>
			</div>
		</div>
			
		<div class="block">
			
			<h2 class="heading">
				{{mosaic.title}}
			</h2>
			
			<div class="row" style="margin-top:.5rem;">
				
				<div class="item-6 ta-right">
					<button class="badge-btn badge-mini" ng-click="love();" ng-disabled="!user.authenticated">
						<span>{{mosaic.lovers}}</span>
						<i class="fa fa-heart" ng-class="{'c-red':mosaic.is_loved}"></i>
					</button>
				</div>
				
				<div class="item-6">
					<button class="badge-btn badge-mini" ng-click="complete();" ng-disabled="!user.authenticated">
						<span>{{mosaic.completers}}</span>
						<i class="fa fa-check-square" ng-class="{'c-green':mosaic.is_completed}"></i>
					</button>
				</div>
				
			</div>
			
			<div class="row" style="margin-top:.5rem; height:29px;">
				
				<div class="item-6 ta-right">
					
					<div id="fb-root"></div>
					
					<script>
						(function(d, s, id) {
							var js, fjs = d.getElementsByTagName(s)[0];
							if (d.getElementById(id)) return;
							js = d.createElement(s); js.id = id;
							js.src = "//connect.facebook.net/fr_FR/sdk.js#xfbml=1&version=v2.10";
							fjs.parentNode.insertBefore(js, fjs);
						}(document, 'script', 'facebook-jssdk'));
					</script>
					
					{% endverbatim %}
					<div class="fb-share-button" data-href="https://www.myingressmosaics.com/mosaic/{{ref}}" data-layout="button_count" data-size="small" data-mobile-iframe="true">
						<a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Fplugins%2F&amp;src=sdkpreparse"></a>
					</div>
					{% verbatim %}
				
				</div>
				
				<div class="item-6">
					
					{% endverbatim %}
					<script src="https://apis.google.com/js/platform.js" async defer></script>
					<div class="g-plus" data-action="share" data-annotation="bubble" data-href="https://www.myingressmosaics.com/mosaic/{{ref}}"></div>			
					{% verbatim %}
					
				</div>
				
			</div>
				
		</div>
		
		<div class="block">
			<div class="tabs">
					
				<div class="item-4 ta-right">
					<button class="btn-secondary btn-block btn-mini" ng-click="detailsMode = true; missionsMode = false; commentsMode = false;" ng-class="{'active': detailsMode}">
						Details
					</button>
				</div>
					
				<div class="item-4 ta-right">
					<button class="btn-secondary btn-block btn-mini" ng-click="initMap(); detailsMode = false; missionsMode = true; commentsMode = false;" ng-class="{'active': missionsMode}">
						<span ng-if="mosaic.has_fake" class="c-warning"><i class="fa fa-warning text-separator"></i></span>
						Missions
					</button>
				</div>
				
				<div class="item-4">
					<button class="btn-secondary btn-block btn-mini" ng-click="detailsMode = false; missionsMode = false; commentsMode = true;" ng-class="{'active': commentsMode}">
						Comments
					</button>
				</div>
				
			</div>
		</div>
		
		<div ng-init="detailsMode = true;" ng-show="detailsMode">
	
			<div class="block">
				
				<div class="title subblock">
					Start this mosaic
				</div>
				
				<div class="panel valign-center align-center">

                    <div class="item" style="padding-top:0; padding-bottom:0;">
                        <a class="btn-primary btn-icon" href="https://www.ingress.com/intel?ll={{mosaic.startLat}},{{mosaic.startLng}}&z=17&pll={{mosaic.startLat}},{{mosaic.startLng}}" target="blank">
                            <i class="fa fa-fw fa-external-link"></i>
                        </a>
                    </div>
                    
                    <div class="item" style="padding-top:0; padding-bottom:0;">
                        <a class="btn-primary btn-icon" href="https://www.google.com/maps/dir//{{mosaic.startLat}},{{mosaic.startLng}}" target="blank">
                            <i class="fa fa-fw fa-map-marker"></i>
                        </a>
                    </div>
                    
                    <div class="item" style="padding-top:0; padding-bottom:0;">
                        <a class="btn-primary btn-icon" href="https://waze.com/ul?ll={{mosaic.startLat}},{{mosaic.startLng}}" target="blank">
                            <img src="/static/img/waze.png">
                        </a>
                    </div>
	                    
				</div>
				
			</div>
			
			<div class="block">
				
				<div class="title subblock">
					Preview
				</div>
				
				<div class="panel">
					
					<div class="item-12">
						<div style="display:flex; align-items:center; justify-content:center; background:#0b0c0d; padding:.25rem;">
						
							<div class="row" style="align-items:center; justify-content:center; padding:0 calc((6 - {{mosaic.cols}}) / 2 * 16.666667%); width:100%;">
					            <div ng-repeat="m in mosaic.missions | reverse" style="flex:0 0 calc(100% / {{mosaic.cols}});">
					                <img src="/static/img/mask.png" style="width:100%; background-color:#000000; background-image:url({{m.image}}=s100); background-size: 95% 95%; background-position: 50% 50%; float:left; background-repeat: no-repeat;" />
					            </div>
				            </div>
				
						</div>
					</div>
					
					<div class="item-12 ta-center">
						{{mosaic.missions.length}} <i class="fa fa-th mx-1"></i>
						<span class="text-separator">&middot;</span>
						{{mosaic.type}}
						<span ng-show="mosaic.type ==  'sequence'">
							<span class="text-separator">&middot;</span>
							{{mosaic.distance | number:2}} km
							<span ng-show="mosaic.distance > 10.0" class="text-separator">&middot;</span>
							<i ng-show="mosaic.distance > 10.0 && mosaic.distance < 30.0" class="fa fa-bicycle"></i>
							<i ng-show="mosaic.distance > 30.0" class="fa fa-car"></i>
						</span>
					</div>
					
					<div class="item-12 ta-center">
						{{mosaic.portals}} waypoints
						<span class="text-separator">&middot;</span>
						{{mosaic.uniques}} uniques
					</div>
					
					<div class="item-12 row align-center">
			        	<div class="item" ng-repeat="creator in mosaic.creators" ng-class="{'c-enligtened': creator.faction == 'E', 'c-resistance': creator.faction == 'R',}">
			        		{{creator.name}}
			        	</div>
					</div>
	
				</div>
				
			</div>
			
			<div ng-show="user.superuser || mosaic.registerer == user" class="block">
				
				<div class="title subblock">
					Edit details
				</div>
				
	            <div class="panel">
	
	    	        <div class="item-6 item-xl-4">
	    	            <label>Title</label>
	    	            <input type="text" class="form-control" ng-model="mosaic.title" />
	    	        </div>
		        
	    	        <div class="item-6 item-xl-4">
	    	            <label>Type</label>
	    	            <select class="form-control" ng-model="mosaic.type">
	    	                <option value="sequence">sequence</option>
	    	                <option value="serie">serie</option>
	    	            </select>
	    	        </div>
	
	    	        <div class="item-6 item-xl-4">
	    	            <label>Columns</label>
	    	            <select class="form-control" ng-model="mosaic.cols" />
	        	                <option value="6">6</option>
	        	                <option value="5">5</option>
	        	                <option value="4">4</option>
	        	                <option value="3">3</option>
	        	                <option value="2">2</option>
	        	                <option value="1">1</option>
	       	            </select>
	    	        </div>
	
	    	        <div class="item-6 item-xl-4">
	    	            <label>Country</label>
	    	            <input type="text" class="form-control" ng-model="mosaic.country" />
	    	        </div>
	
	    	        <div class="item-6 item-xl-4">
	    	            <label>Region</label>
	    	            <input type="text" class="form-control" ng-model="mosaic.region" />
	    	        </div>
	
	    	        <div class="item-6 item-xl-4">
	    	            <label>City</label>
	    	            <input type="text" class="form-control" ng-model="mosaic.city" />
	    	        </div>
	    	        
	    	        <div class="item-12 ta-center">
	    	        	
	    				<button class="btn-primary ta-center" style="width:100px;" ng-click="updateMosaic();" ng-disabled="updating || !mosaic.title || !mosaic.type || !mosaic.cols || !mosaic.country">
	            			<span ng-show="updating">
	            				<i class="fa fa-spinner"></i>
	            			</span>
	    				    Save
	    				</button>
	    
	    	        </div>
	    	        
				</div>
				
			</div>
			
			<div ng-show="user.superuser || mosaic.registerer == user" class="block">
				
				<div class="title subblock">
					Delete mosaic
				</div>
				
				<form class="panel">
					<div class="item grow">
						<input type="text" class="form-control" placeholder="Mosaic name" ng-model="deleteModelName" />
					</div>
					<div class="item">
		    			<button type="submit" class="btn btn-primary" ng-click="delete(deleteModelName);">
		    				Delete
		    			</button>
		    		</div>
	    		</form>
				
			</div>
			
		</div>
		
		<div ng-show="missionsMode">
		
			<div class="block">
		
				<div ng-if="mosaic.has_fake" class="subblock">
					
					<div class="ta-center c-warning">
						<i class="fa fa-warning text-separator"></i>
						Some missions are missing. Please post comment if you know they are available.
					</div>
					
				</div>
				
				<div class="title subblock">
					Roadmap
				</div>
				
				<div class="panel">
				
					<div class="item-12">
						<div id="map"></div>
					</div>
	
				</div>
			
				<div class="panel" ng-repeat="item in mosaic.missions">
				
				<div class="item-12 hover">
					
					<div class="row valign-center">
						
	                    <div class="item c-white" ng-click="toggleMission(item);">
	                    	<i ng-hide="item.expanded" class="mr-2 fa fa-fw fa-caret-right"></i>
	                    	<i ng-show="item.expanded" class="mr-2 fa fa-fw fa-caret-down"></i>
	                    </div>
	                    
	                    <div class="item grow c-white" ng-click="toggleMission(item);" ng-class="{'c-white':item.title!='Fake mission', 'c-danger':item.title=='Fake mission'}">
	                        {{item.title}}
	                    </div>
	                    
	                    <div class="item" style="padding-top:0; padding-bottom:0;">
	                        <a class="btn-primary btn-icon" href="https://www.ingress.com/intel?ll={{item.startLat}},{{item.startLng}}&z=17&pll={{item.startLat}},{{item.startLng}}" target="blank">
	                            <i class="fa fa-fw fa-external-link"></i>
	                        </a>
	                    </div>
	                    
	                    <div class="item" style="padding-top:0; padding-bottom:0;">
	                        <a class="btn-primary btn-icon" href="https://www.google.com/maps/dir//{{item.startLat}},{{item.startLng}}" target="blank">
	                            <i class="fa fa-fw fa-map-marker"></i>
	                        </a>
	                    </div>
	                    
	                    <div class="item" style="padding-top:0; padding-bottom:0;">
	                        <a class="btn-primary btn-icon" href="https://waze.com/ul?ll={{item.startLat}},{{item.startLng}}" target="blank">
	                            <img src="/static/img/waze.png">
	                        </a>
	                    </div>
                      
	                </div>
	                
                </div>
                
                <div class="item-12" ng-show="item.expanded">
	                <div style="padding:.25rem; background-color:rgba(0,0,0,.25);">
	
						<div ng-show="item.title=='Fake mission'" class="item-12 c-danger">
							Mission missing. Please post comment if you know it is available.
						</div>
						
						<div ng-show="item.title!='Fake mission'" class="item-12">
							{{item.portals.length}} waypoints
							<i class="text-separator fa fa-long-arrow-right"></i>
	        				<span class="" ng-repeat="portal in item.portals">
	        					<span ng-if="$index > 0" class="text-separator">&middot;</span>
	        					<span ng-class="{'c-lighter':!portal.unavailable, 'c-danger':portal.unavailable}">
	        						<span ng-if="portal.action == 0">Objectives</span>
	        						<span ng-if="portal.action == 1">Hack</span>
	        						<span ng-if="portal.action == 2">Capture or Upgrade</span>
	        						<span ng-if="portal.action == 7">View</span>
	        						<span ng-if="portal.action == 8">Passphrase</span>
	        					</span>
	        				</span>
	        			</div>
						
						<div ng-show="item.title!='Fake mission'" class="item-12">
	                        {{item.desc}}
	                    </div>
	
	                </div>
	                
	            </div>
            </div>
            
			</div>
		
			<div ng-show="user.superuser || mosaic.registerer == user" class="block">
				
				<div class="title subblock">
					Reorder or remove mission
				</div>
				
                <div class="panel valign-center" ng-repeat="item in mosaic.missions">

					<div class="item">
						<input class="form-control ta-center" ng-model="item.order" ng-blur="reorderMission($index, item.ref, item.order);"  style="min-width:2.5rem; width:2.5rem; min-height:1.5rem; line-height:1.5rem;" />
					</div>

					<div class="item grow ellipsis">
						{{item.title}}
					</div>

					<div class="item">
						<a ng-click="remove(item.ref, $index);">
							<i class="fa fa-trash"></i>
						</a>
					</div>
						
                </div>

			</div>
			
			<div ng-show="user.superuser || mosaic.registerer == user" class="block">
				
				<div class="title subblock">
					Add fake mission
				</div>
				
		     	<form class="panel valign-center">

		        	<div class="item grow c-danger">
		        	    If your mosaic is not complete, you could add 'fake' missions and complete it later.
		        	</div>
		        	
					<div class="item">
						<input type="text" class="form-control ta-center" placeholder="order" ng-model="fakeorder" />
					</div>
					
					<div class="item">
						<button type="submit" class="btn-primary" ng-click="addFake(fakeorder); fakeorder=null;">
							Add
						</button>
					</div>
					
				</form>
				
			</div>
			
			<div ng-show="user.superuser || mosaic.registerer == user" class="block">
				
				<div class="title subblock">
					Add missing mission
				</div>

		     	<form class="panel">
					<div class="item grow">
						<input type="text" class="form-control" ng-model="searchtext" />
					</div>
					<div class="item">
						<button type="submit" class="btn-primary" ng-click="searchMission(searchtext);">
							Search
						</button>
					</div>
				</form>
				
				<div ng-show="displayResults">
					
					<div ng-if="searching" class="block ta-center">
						<i class="fa fa-spinner"></i>
						Searching for missions...
					</div>
					
					<div ng-if="!searching && missions.length < 1" class="block ta-center c-danger">
						No mission found
					</div>
					
	                <div class="panel valign-center" ng-repeat="item in missions">

                        <div class="item">
                             <a ng-click="addMission(item);"><i class="fa fa-plus-square"></i></a>
                         </div>
	
						<div class="item">
							<input class="form-control ta-center" ng-model="item.order" style="min-width:2.5rem; width:2.5rem; min-height:1.5rem; line-height:1.5rem;" />
						</div>
	
						<div class="item grow ellipsis">
							{{item.title}}
						</div>
	                    
                        <div class="item" ng-class="{'c-enligtened': item.faction == 'E', 'c-resistance': item.faction == 'R',}">
                            {{item.creator}}
                        </div>
							
	                </div>
	                
				</div>
				
			</div>
			
		</div>
		
		<div ng-show="commentsMode" class="block">
            
            <div ng-show="user.authenticated && !addComment && mosaic.comments.length > 0" class="row">
            	
	            <div class="item-12 ta-center">
	            	<a ng-click="addComment=true;">Add a comment</a>
	            </div>
	            
            </div>
            
            <div ng-show="addComment || (user.authenticated && mosaic.comments.length < 1)" class="panel">
            	
            	<div class="item-12">
            		<textarea class="form-control" ng-model="newCommentText">
            		</textarea>
            	</div>
            	
            	<div class="item">
            		<button class="btn-primary btn-mini" ng-click="createComment(newCommentText);" ng-disabled="addingComment">
	        			<span ng-show="addingComment">
            				<i class="fa fa-spinner rotating"></i>
            			</span>
            			Save
            		</button>
            	</div>
            	
            	<div class="item">
            		<button class="btn-secondary btn-mini" ng-click="addComment=false;">
            			Cancel
            		</button>
            	</div>
            	
            </div>
            
            <div class="row">
            	<div class="item-12">
           	
		            <div class="panel" ng-repeat="item in mosaic.comments">
		            	
		            	<div class="item-12">
		            		<span ng-class="{'c-enligtened': item.faction == 'E', 'c-resistance': item.faction == 'R',}">{{item.username}}</span>
		            	</div>
		             	
		            	<div ng-show="!item.edit" class="item-12">
		            		{{item.text}}
		            	</div>
		           	
		            	<div ng-show="item.edit" class="item-12">
		            		<textarea class="form-control" ng-model="item.text">
		            			{{item.text}}
		            		</textarea>
		            	</div>
		            	
		            	<div ng-show="item.edit" class="item">
		            		<button class="btn-primary btn-mini" ng-click="editComment(item);" ng-disabled="item.editing || !item.text">
			        			<span ng-show="item.editing">
		            				<i class="fa fa-spinner rotating"></i>
		            			</span>
		            			Save
		            		</button>
		            	</div>
		            	
		            	<div ng-show="item.edit" class="item">
		            		<button class="btn-secondary btn-mini" ng-click="item.edit=false;">
		            			Cancel
		            		</button>
		            	</div>
		            	
		            	<div ng-show="!item.edit" class="item-12">
		            		<a ng-click="item.edit=true;">Edit</a>
		            		<span class="text-separator">&middot;</span>
		            		<a ng-click="deleteComment(item.id, $index);">Delete</a>
		            	</div>
		            	
		            </div>
	            
		        </div>
	        </div>
            
		</div>
	
	</div>

</div>

{% endverbatim %}
{% endblock %}

{% block extra-script %}

	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDuXb2ncs76tO-2SN8hvkE5Zt4VwtPoNcM&amp;language=en"></script>
	
{% endblock %}